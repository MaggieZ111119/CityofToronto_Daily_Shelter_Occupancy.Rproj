---
title: "Marriage Data analysis"
subtitle: "STA304 WEEK 3"
author: 
  - Maggie Zhang
thanks: "Code and data are available at:https://github.com/MaggieZ111119/CityofToronto_Daily_Shelter_Occupancy.Rproj.git"
date: today
date-format: long
abstract: "This paper investigates the occupancy of shelters in Toronto from 2017 to 2020, focusing on capacity and usage across different shelter sectors. By analyzing the data, we explore how shelter demand {exceeded available resources in certain sectors. This research highlights significant challenges faced by the shelter system, providing insights into the strain on resources and potential gaps in support for the homeless population}. These findings are crucial for informing policies and improving resource allocation to better address homelessness in Toronto."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

# Preparation

#Load used libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(knitr)
library(gridExtra)

# Read Data(Quarto need data set to be readed in the file)
shelter_data <- read_csv(here::here("~/CityofToronto_Daily_Shelter_Occupancy.Rproj/data/analysis_data/full_shelter_data.csv"), show_col_types = FALSE)
```


# Introduction

Homelessness is a persistent and complex issue in many areas in Canada(@gaetz2010struggle), and Toronto is no exception. As one of Canada’s largest cities, Toronto faces significant challenges in helping homeless people, who are unable to spend on housing largely due to poverty, to meet the necessities of living(@jadidzadeh2018patterns). The city operates a range of shelters that serve various groups, including men, women, youth, and families. The balance between availability and the demand for these services is crucial for both the well-being of individuals experiencing homelessness and the government's efforts to reduce homelessness population. Understanding how shelter occupancy changes over time is essential for identifying gaps in resources and shaping effective policy responses.

This paper focuses on analyzing shelter occupancy data from 2017 to 2020 in City of Toronto. The data which offers a detailed look at the city’s shelter during this time of period is provided on @OpenDataToronto portal. By examining trends in occupancy through the data, we aim to assess how well Toronto's shelters met the demand for space and where shortages may have occurred. By focusing on specific sectors of the shelter system, pinpoint which groups may have been disproportionately affected by resource limitations. 

FINDING! This study addresses a clear gap in the current literature by providing an up-to-date analysis of Toronto's shelter capacity and usage during a time of unprecedented public health and social challenges. ___ NOTICE!!

The remiander of this paper are in presented in sections: @sec-data : Data, @sec-results :Results, and @sec-discussion :Discussion. The data section introduce the dataset used for analysis, expalinin its source and context that shaped its collection.This section thoroughly summarizes the data using visualizations created with `ggplot2` (@R-ggplot2) and tables produced with `knitr` (@R-knitr). Key variables chosen for the analysis, along with the reasoning behind their selection, are explained. The results section presents the findings drawn from the data, highlighting patterns in shelter occupancy and compare to it's availability. Following by the discussion section, which explores the implications of these findings, particularly in relation to resource allocation and policy development, offering insights into how Toronto's shelter system responded to increasing demand.


# Data {#sec-data}
All data reviewed and analysis in this paper is the Daily Shelter Occupancy @Shelter. The data is essential for evaluating how shelters serve different populations (e.g., men, women, youth, families) and for analyzing the current shelter servise system over time, such as capacity shortfalls or surpluses. It provides inforamtion on all the active shelters exist in the City of Toronto area, collected in forms of four separate datasets corresponding to the years 2017, 2018, 2019, and 2020. 

## Overview {#sec-data-overview}
Each datasets include various characteristics of the shelters. The data was sourced from an Open Data Toronto Portal @OpenDataToronto, with each row indicate a unique entry for a specific sector of specific shelter, on a specific date, and has Unique row identifier for Open Data database, "_id". 

The collection process records information about corresponding name of the non-profit entity that is responsible for the shelter, as well as the name of the facility (e.g. hotel, residence building), along with and their capacity to accommodate homeless clients. The Capacity is being measured as number of bed or a mat/cot available. Something will happen is that for the family sector, it is possible to exceed available capacity depending on the bed number, because family could be accommodated in a room with number beds smaller than number of people in their family.  The data was collected every day, 4:00 AM, to record number of homeless clients occupying the shelters. This way to gather information about occupancy provides a consistent snapshot of shelter use across all organizations. 

Other similar datasets, especialy the ther dataset publish by Toronto Shelter & Support Services, were considered. However, they did not offer the cross-sector view of both occupancy and capacity needed for the focus of this analysis. The selected dataset allows for a broad comparison across time and sectors in different city, providing a fuller picture of trends within the shelter system.


## Feature Selection and Aggregation

For the purpose of this analysis, several features are chose to be particularly focused on. variable of interest including the the city (named "SHELTER_CITY" in the dataset) in which shelters are located; the date of data recorded("OCCUPANCY_DATE"); the sector("SECTOR") of clientele the shelters serve, for example men, women, youth, families, and even co-ed; the shelter's capacities("CAPACITY") and occupancy("OCCUPANCY") levels. These variables were chosen for their relevance in which is to investigate shelter occupancy and capacity across different cities and sectors, focusing on the City of Toronto from 2017 to 2020.

There are also seven other detailed feature in the datasets: "ORGANIZATION_NAME", "SHELTER_NAME", "SHELTER_ADDRESS", "SHELTER_PROVINCE", "SHELTER_POSTAL_CODE", "FACILITY_NAME", and "PROGRAM_NAME". Using R programming lanaguage @citeR, the `janitor`@R-janitor, `tidyverse` @R-tidyverse, and `dplyr` @R-dplyr pakages are used in data simulation, downloading, cleaning, and writting test. No new variables were created for this analysis, but the data was aggregated by grouping observations by city, date, and sector. This aggregation facilitated a more comprehensive comparison across cities and sector groups. A random sample of the cleaned data can be seen in @fig-shelter-sample.
```{r}
#| label: fig-shelter-sample
#| tbl-cap: Sample of Cleaned Shelter Data
#| echo: false
#| message: false

set.seed(1009633096)
indices <- sample(1:nrow(shelter_data), 5)

kable(shelter_data[indices,],
      caption = "Sample of Cleaned Shelter Data")

```



## Data Breakdown
As shown in @fig-shelter-full-table, The four cities being observed in the dataset are Toronto, Etobicoke, North York, and Scarborough. The sectors recorded include Co-ed (mixture), Families, Men, Women, and Youth. Across all cities, record for Youth age group being presents. In fact, Youth is the only population in Etobicoke and North York. In Toronto, which has the most number of observation recorded, equal number of sectors are being observed, but how these people in distributed inthe total popluation are not clear. This will be further addressed in the following sections.
```{r}
#| label: fig-shelter-full-table
#| tbl-cap: Number of Observations by City and Sector
#| echo: false
#| message: false

# Count the number of observations by city and sector
city_sector_breakdown <- shelter_data %>%
  group_by(shelter_city, sector) %>%
  count() %>%
  spread(key = sector, value = n, fill = 0)

# Check if the total is being calculated correctly
city_sector_breakdown$Sum <- rowSums(city_sector_breakdown[,2:6], na.rm = TRUE)

# Display the table with correct formatting
city_sector_breakdown %>%
  kable(caption = "Number of Observations by City and Sector")


```

The following table @fig-shelter-diff-city provides a summary of the average, maximum, and minimum occupancy, as well as capacity metrics for each city. Toronto has most amount of shelter avaliable and also has most people occuupaying in. The Maximum occupany of Toronto in a day, combined all sectors, from 2017 to 2020,is 6803. Wheras Etobicoke only has 53 people occupanying. The fact that Etotobike has only hoemless people in the group of Youth recorded could explain alittle bit. But, the de=ifference still strong enough to see that the homeless population might be significant larger in Toronto compared to aother cities. 
```{r}
#| label: fig-shelter-diff-city
#| tbl-cap: Statistics for Homeless Shelter Occupancy by City
#| echo: false
#| message: false

# Because the data originally has one date and is separated into several rows with different sectors. 
# If I want to calculate the total occupancy of that date in that city, I need to add all sector information together. Then, we will see the average, max, mix of occupancy. 
# Same idea to capacity.

toronto_data <- shelter_data %>% 
  filter(shelter_city == "Toronto") %>% 
  group_by(occupancy_date) %>%
  summarise(
    total_occupancy = sum(total_occupancy, na.rm = TRUE),
    total_capacity = sum(total_capacity, na.rm = TRUE),
    .groups = 'drop'
  )

north_york_data <- shelter_data %>% 
  filter(shelter_city == "North York") %>%
  group_by(occupancy_date) %>%
  summarise(
    total_occupancy = sum(total_occupancy, na.rm = TRUE),
    total_capacity = sum(total_capacity, na.rm = TRUE),
    .groups = 'drop'
  )
  

scarborough_data <- shelter_data %>% 
  filter(shelter_city == "Scarborough")%>%
  group_by(occupancy_date) %>%
  summarise(
    total_occupancy = sum(total_occupancy, na.rm = TRUE),
    total_capacity = sum(total_capacity, na.rm = TRUE),
    .groups = 'drop'
  )

etobicoke_data <- shelter_data %>% 
  filter(shelter_city == "Etobicoke") %>%
  group_by(occupancy_date) %>%
  summarise(
    total_occupancy = sum(total_occupancy, na.rm = TRUE),
    total_capacity = sum(total_capacity, na.rm = TRUE),
    .groups = 'drop'
  )

# Summary statistics for each city
toronto_summary <- toronto_data %>%
  summarise(
    avg_occupancy = mean(total_occupancy, na.rm = TRUE),
    max_occupancy = max(total_occupancy, na.rm = TRUE),
    min_occupancy = min(total_occupancy, na.rm = TRUE),
    avg_capacity = mean(total_capacity, na.rm = TRUE),
    max_capacity = max(total_capacity, na.rm = TRUE),
    min_capacity = min(total_capacity, na.rm = TRUE)
  ) 
 

north_york_summary <- north_york_data %>%
  summarise(
    avg_occupancy = mean(total_occupancy, na.rm = TRUE),
    max_occupancy = max(total_occupancy, na.rm = TRUE),
    min_occupancy = min(total_occupancy, na.rm = TRUE),
    avg_capacity = mean(total_capacity, na.rm = TRUE),
    max_capacity = max(total_capacity, na.rm = TRUE),
    min_capacity = min(total_capacity, na.rm = TRUE)
  )


scarborough_summary <- scarborough_data %>%
  summarise(
    avg_occupancy = mean(total_occupancy, na.rm = TRUE),
    max_occupancy = max(total_occupancy, na.rm = TRUE),
    min_occupancy = min(total_occupancy, na.rm = TRUE),
    avg_capacity = mean(total_capacity, na.rm = TRUE),
    max_capacity = max(total_capacity, na.rm = TRUE),
    min_capacity = min(total_capacity, na.rm = TRUE)
  )


etobicoke_summary <- etobicoke_data %>%
  summarise(
    avg_occupancy = mean(total_occupancy, na.rm = TRUE),
    max_occupancy = max(total_occupancy, na.rm = TRUE),
    min_occupancy = min(total_occupancy, na.rm = TRUE),
    avg_capacity = mean(total_capacity, na.rm = TRUE),
    max_capacity = max(total_capacity, na.rm = TRUE),
    min_capacity = min(total_capacity, na.rm = TRUE)
  ) 
  


city <- c("Toronto", "North York", "Scarborough", "Etobicoke")
combined_summary <- bind_rows(toronto_summary,
                          north_york_summary,
                          scarborough_summary,
                          etobicoke_summary)
combined_summary$city <- city
combined_summary <- combined_summary %>%
  select(city, everything()) 

kable(combined_summary, 
             col.names = c("City", 
                           "Average Occupancy", 
                           "Max Occupancy", 
                           "Min Occupancy", 
                           "Average Capacity", 
                           "Max Capacity", 
                           "Min Capacity"),
      caption = "Statistics for Homeless Shelter Occupancy by City")
```
The relastion ship of two key feature, occupancy and capacity, are essential for understaidng current shelter servise system. The relashipship is reflected in @fig-occupancy-capacity-relashionship. Occupany and capacity are greatly follwing a positive correlation, indicating that most there aren't much over-investment to the shelter system, nor heavily over-filled shelter. But there are noticible deviation from the perfect correlation to above, these are suggecting there are cases where occupany is higher than capacity, suggesting occupantee may living in a overly paked places. More will be dicussed in  @sec-results, including other learning on the shelter servise like thier trend, and how these shelter information possiblly reflect the homeless.
```{r}
#| label: fig-occupancy-capacity-relashionship
#| fig-cap: Relationship Between Total Occupancy and Total Capacity in Shelter of the City of Toronto
#| fig-pos: "H"
#| echo: false
#| message: false

ggplot(shelter_data, aes(x = total_capacity, y = total_occupancy, color = sector)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Relationship Between Total Occupancy and Total Capacity in Shelter of the City of Toronto",
       x = "Total Capacity",
       y = "Total Occupancy",
       color = "Sector") +
  theme_minimal() +
  scale_color_brewer(palette = "Set1")

```


# Results {#sec-results}
Through grpahfical study of the datset, some usful information are found and the result will be dicussed in this section. 

## Shelter Occupancy Trend over Time
The figure @fig-shelter-over-time as dipict the trend of homless poeple occupiying shelters in each city. A high in occupancy are notice in all four city around the time between late 2019 to early 2020. Especially, there is a obviouse rising trend in Scarborough. Combined with the information on the "About Daily Shelter Occupancy" section in the data website @Shelter, it rise may be subjectted to the ourbreak of COVID_19. The occpany number going significantly decrease from mid 2020, across all four cities also suggest this finding. 
```{r}
#| label: fig-shelter-over-time
#| fig-cap: Visualization of Shelter Occupancy During Time Period 2017 to 2020
#| echo: false
#| message: false

# Assuming you have a data frame 'shelter_data' with total occupancy for each city
# Create individual plots for each city
toronto_plot <- ggplot(toronto_data %>% slice(seq(1, n(), by = 50)), aes(x = occupancy_date, y = total_occupancy)) +
  geom_line(color = "blue") +
  labs(title = "Toronto Occupancy Trends",
       x = "Date",
       y = "Total Occupancy") +
  theme_minimal()

north_york_plot <- ggplot(north_york_data%>% slice(seq(1, n(), by = 50)), aes(x = occupancy_date, y = total_occupancy)) +
  geom_line(color = "green") +
  labs(title = "North York Occupancy Trends",
       x = "Date",
       y = "Total Occupancy") +
  theme_minimal()

scarborough_plot <- ggplot(scarborough_data%>% slice(seq(1, n(), by = 50)), aes(x = occupancy_date, y = total_occupancy)) +
  geom_line(color = "red") +
  labs(title = "Scarborough Occupancy Trends",
       x = "Date",
       y = "Total Occupancy") +
  theme_minimal()

etobicoke_plot <- ggplot(etobicoke_data%>% slice(seq(1, n(), by = 50)), aes(x = occupancy_date, y = total_occupancy)) +
  geom_line(color = "orange") +
  labs(title = "Etobicoke Occupancy Trends",
       x = "Date",
       y = "Total Occupancy") +
  theme_minimal()

combined_plot <- grid.arrange(toronto_plot, north_york_plot, 
                               scarborough_plot, etobicoke_plot, 
                               nrow = 2, ncol = 2,
                               top = "Visualization of Shelter Occupancy During Time Period 2017 to 2020"
                          )

# This will suppress the grid output in the document
invisible(combined_plot)

```


## Shelter Utilization Analysis
The Utilization Rate as being calculated as:
$$\text{Utilization Rate} = \left( \frac{\text{Number of Occupancy}}{\text{Number of Capacity}} \right) \times 100\%$$
From @fig-shelter-utilization, it's the utilization rate in Toronto remains the lowest over 4 years almost all the time compared to other cities, but still in a relativly high number. This suggest that shelter servise croass all four cities are not over-inveseting, their servise are actually helping the hoemelss population since alot of people are using them. There is a significant decrease in utilization rate from Fall 2019 to Summer 2020, despite the increase in occupation number as sugessted in @fig-shelter-over-time. This incicated that more shelter are timely provided, the goverment are providing larger amount of shelter than usual during pandemic. This actully can be visulized in @fig-shelter-provided, espcially in the case for Scarborugh, there is a noticibke peak at very end of 2019 and start of 2020.
```{r}
#| label: fig-shelter-utilization
#| fig-cap: Yearly change in Utilization Rate Average on All Shelters by City (2017-2020)
#| echo: false
#| message: false
#| warning: false

# Calculate utilization rate by city
toronto_data <- toronto_data %>%
  mutate(utilization_rate = total_occupancy / total_capacity)

north_york_data <- north_york_data %>%
  mutate(utilization_rate = total_occupancy / total_capacity)

scarborough_data <- scarborough_data %>%
  mutate(utilization_rate = total_occupancy / total_capacity)

etobicoke_data <- etobicoke_data %>%
  mutate(utilization_rate = total_occupancy / total_capacity)

# Combine all city datasets
combined_data <- bind_rows(
  toronto_data %>% mutate(shelter_city = "Toronto"),
  north_york_data %>% mutate(shelter_city = "North York"),
  scarborough_data %>% mutate(shelter_city = "Scarborough"),
  etobicoke_data %>% mutate(shelter_city = "Etobicoke")
)

# Extract year from occupancy_date
combined_data <- combined_data %>%
  mutate(year = year(occupancy_date),
         month = month(occupancy_date),
         season = case_when(
           month %in% c(12, 1, 2) ~ "Winter",
           month %in% c(3, 4, 5) ~ "Spring",
           month %in% c(6, 7, 8) ~ "Summer",
           month %in% c(9, 10, 11) ~ "Fall"
         ))


# Have data into seasons
combined_data <- combined_data %>%
  mutate(season_year = factor(paste(season, year), 
                               levels = c("Winter 2017", "Spring 2017", "Summer 2017", "Fall 2017",
                                          "Winter 2018", "Spring 2018", "Summer 2018", "Fall 2018",
                                          "Winter 2019", "Spring 2019", "Summer 2019", "Fall 2019",
                                          "Winter 2020", "Spring 2020", "Summer 2020", "Fall 2020")))

# Calculate average utilization rate
annual_utilization <- combined_data %>%
  group_by(season_year, shelter_city) %>%
  summarise(avg_utilization_rate = mean(utilization_rate, na.rm = TRUE), .groups = 'drop')



ggplot(annual_utilization, aes(x = season_year, y = avg_utilization_rate, color = shelter_city, group = shelter_city)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(x = "Seasons",
       y = "Average Utilization Rate",
       color = "City",
       caption = "Utilization Rate Average Change on All Shelters by City") +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format(scale = 100)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
#| label: fig-shelter-provided
#| fig-cap: Shelter Capacity During Time Period 2017 to 2020 of CIties
#| echo: false
#| message: false
#| warning: false

# Create individual plots for each city
toronto_plot <- ggplot(
  toronto_data %>% slice(seq(1, n(), by = 100)), 
                         aes(x = occupancy_date, y = total_capacity)) +
  geom_line(size = 1, color = "blue") +
  geom_point(size = 2) +
  labs(title = "Toronto", x = "Year", y = "Capacity") +
  theme_minimal()

north_york_plot <- ggplot(
  north_york_data %>% slice(seq(1, n(), by = 100)), 
  aes(x = occupancy_date, y = total_capacity)) +
  geom_line(size = 1, color = "green") +
  geom_point(size = 2) +
  labs(title = "North York", x = "Year", y = "Capacity") +
  theme_minimal()

scarborough_plot <- ggplot(
  scarborough_data %>% slice(seq(1, n(), by = 100)), 
  aes(x = occupancy_date, y = total_capacity)) +
  geom_line(size = 1, color = "red") +
  geom_point(size = 2) +
  labs(title = "Scarborough", x = "Year", y = "Capacity") +
  theme_minimal()

etobicoke_plot <- ggplot(
  etobicoke_data %>% slice(seq(1, n(), by = 100)), 
  aes(x = occupancy_date, y = total_capacity)) +
  geom_line(size = 1, color = "orange") +
  geom_point(size = 2) +
  labs(title = "Etobicoke", x = "Year", y = "Capacity") +
  theme_minimal()

# Combine the four plots into a single figure
combined_plot_cap <- grid.arrange(toronto_plot, north_york_plot, 
                              scarborough_plot, etobicoke_plot, 
                              nrow = 2, ncol = 2,
                              top = "Visualization of Shelter Capacity During Time Period 2017 to 2020")

# Display the combined plot
invisible(combined_plot_cap)

```


## Over Capacity Cases
The relashipship between Occupancy and Capcity over this four year (see @fig-occupancy-capacity-relashionship) are revealling cases where more tha expectted people are living in the shelter, as we dicusssued in Data section @sec-data. These cases where capacity is exceeded (when $occupancy > capacity$) are importent when considering improvement shelter system improvement. By further invisted to the dataset, we are ablt to identify cases are actually happens to Families sector in Toronto (see @fig-overcapacity). And all other sector didn't expereince overcorwaaed shelter. Think incidate the quility of shleter servise is good at most case. Families sector are expereiceing overcraodded shelter does not implies the shelter system's fault, it is likely that families with children are assigned to a room with bed/mat that is smaller compared to thier family size. 2 children are able to sleep in one bed, this does not seems like a proalem. For example, a family of five with small children, can elect to be accommodated in a room with four beds, as stated in explanamtion of "CAPACITY" feature in the Portal @Shelter.

```{r}
#| label: fig-overcapacity
#| tbl-cap: Overcrowded Cases by City and Sector
#| echo: false
#| message: false

# Filter for overcrowded data
overcrowded_data <- shelter_data %>%
  filter(total_occupancy > total_capacity)

# Create a frequency table including all cities and sectors
frequency_table <- overcrowded_data %>%
  group_by(shelter_city, sector) %>%
  summarise(count = n(), .groups = 'drop') %>%
  complete(shelter_city, sector, fill = list(count = 0)) %>%
  pivot_wider(names_from = sector, values_from = count)

# Create a complete dataset of all combinations of cities and sectors
all_combinations <- expand.grid(
  shelter_city = unique(shelter_data$shelter_city),
  sector = unique(shelter_data$sector)
)

# Create a frequency table including all cities and sectors
frequency_table <- overcrowded_data %>%
  group_by(shelter_city, sector) %>%
  summarise(count = n(), .groups = 'drop') %>%
  right_join(all_combinations, by = c("shelter_city", "sector")) %>%
  replace_na(list(count = 0)) %>%
  pivot_wider(names_from = sector, values_from = count, values_fill = 0)

# View the frequency table with knitr
frequency_table %>%
  kable(caption = "Overcrowded Cases by City and Sector")

```




# Discussion {#sec-discussion}

## Shelter servise evaluation

Based on the information said in @sec-results, particularly  @fig-shelter-utilization, we can see the selter servise system in the CIty of Toronto are indded good structured. The untillization rate is usually in the 90% - 100% region. Suggesting that what being provided are well-used and supportivie to the homeless community.

## COVID-19 Effect

Thorugh looking at the plot @fig-shelter-over-time, the ococupanny of shleters are at the highest around WInter 2019 to the begining of 2020. The pendenmic is indeed infecting the homeless population across four cities. Government actual in react to the outbreak of COVID-19, in intend to support homeless population are represnted on @fig-shelter-provided, with higher capacities of living nessecities provided. Thorugh higher capaciticies of existing shelter,s or adding in new shelters. 


## Weaknesses and next steps {#sec-weakness}

COVID-19 is inded empacting on homeless populations, 

\newpage

\appendix

# Appendix {-}


# References


